{% extends "base.html" %}

{% block below_tagline %}
<a id="more-link" href="#"
   onclick="toggle('more-link'); toggle('more'); return false;">More...</a>
{% endblock %}


{% block content %}

<div id="more" style="display: none" />
<p>Brid.gy sends
<a href="http://webmention.org/">webmentions</a> for comments and likes on
Facebook, Twitter, Google+, and Instagram. Brid.gy notices when you post links,
watches for comments and likes on those posts, and sends them back to your site
as webmentions. It also serves them as
<a href="http://microformats.org/wiki/microformats2">microformats2</a> for
webmention targets to read.</p>

<p>You can <a href="#users">see who's using Brid.gy</a>, click on a button
below to try it yourself, or read <a href="/about">even more details.</a></p>
</div>


<!-- Connect buttons -->
<div id="connect" class="row">
<div class="col-md-3 col-sm-6"><form method="post" action="/facebook/start">
    <input type="image" alt="Sign in with Facebook" src="/static/facebook_button.png" />
</form></div>
<div class="col-md-3 col-sm-6"><form method="post" action="/twitter/start">
  <input type="image" alt="Sign in with Twitter" src="/static/twitter_button.png" />
</form></div>
<div class="clearfix visible-xs"></div>
<div class="col-md-3 col-sm-6"><form method="post" action="/googleplus/start">
  <input type="image" alt="Sign in with Google+" src="/static/google_plus_button.png" />
</form></div>
<div class="col-md-3 col-sm-6"><form method="post" action="/instagram/start">
  <input type="image" alt="Sign in with Instagram" src="/static/instagram_button.png" />
</form></div>
</div>

<br />

<!-- Users -->
<p id="users" class="big row">Registered accounts:</p>

{# TODO: paging #}
<div id="sources">
{% for source in sources %}

<div id="{{ source.dom_id }}" class="row">
 <div class="col-sm-4">
  <a target="_blank" href="{{ source.url }}"
     title="{{ source.DISPLAY_NAME }}: {{ source.name|safe }}">
    <img class="profile" src="{{ source.picture }}" width="64px" />
    <img src="/static/{{ source.SHORT_NAME }}_icon.png"
         alt="{{ source.DISPLAY_NAME }}" />
    {{ source.name|safe }}</a>

  <span class="source-buttons">
  <a href="#{{ source.dom_id }}" title="Link">#</a>
  {% if source.status == "disabled" %}
    <span class="glyphicon glyphicon-exclamation-sign"
          title="This source was disconnected on {{ source.DISPLAY_NAME }}'s
                 end. To fix this, delete and re-add it."></span>
  {% endif %}
  <form method="post" action="/delete/start">
    <input name="key" type="hidden" value="{{ source.key }}" />
    <button type="submit" title="Delete" class="delete">&times;</button>
  </form>
  </span>

 </div><div class="col-sm-4">
  {% if source.last_poll_attempt == epoch %}
    Not polled yet
  {% else %}
    Polled
    <a href="/log?start_time={{ source.last_poll_attempt|date:'U' }}&key={{ source.key }}">
      {{ source.last_poll_attempt|timesince }} ago
    {% if source.status == "error" %}
     <span title="Error" class="glyphicon glyphicon-exclamation-sign"></span>
    {% endif %}
    </a>
  {% endif %}

  <!-- <form method="post" action="/poll"> -->
  <!--   <input name="key" type="hidden" value="{{ source.key }}" /> -->
  <!--   <button type="submit" title="Poll now" class="glyphicon glyphicon-refresh" -->
  <!--           style="border: none; background: none;"></button> -->
  <!-- </form> -->

 </div><div class="col-sm-4">
  {% if source.recent_responses %}
    <a href="#" onclick="toggle('responses-{{ source.dom_id }}'); return false;">
      Recent responses...
    {% if source.recent_response_status == "processing" %}
     <span title="Processing" class="glyphicon glyphicon-transfer"></span>
    {% else %}{% if source.recent_response_status == "error" %}
     <span title="Error" class="glyphicon glyphicon-exclamation-sign"></span>
    {% endif %}{% endif %}
    </a>
  {% else %}
    No responses yet
  {% endif %}
 </div>
</div>

<ul id="responses-{{ source.dom_id }}" class="responses" style="display: none" />
  {% for response in source.recent_responses %}
  <li class="row">
   <div class="col-sm-3">
    {% with response.response as r %}
    <a target="_blank" href="{{ r.author.url }}" title="{{ r.author.displayName }}">
      <img class="profile" src="{{ r.author.image.url }}" width="32" /></a>
      <a target="_blank" href="{{ r.url }}">
        {{ r.content|default:"--"|striptags|truncatewords:6|safe }}</a>
    {% endwith %}

   </div><div class="col-sm-3">
    {% with response.activity.object as a %}
    {% if response.type == "comment" %} on {% endif %}
    <a target="_blank" href="{{ a.url }}">
      {{ a.content|default:"--"|striptags|truncatewords:6|safe }}</a>
    {% endwith %}

   </div><div class="col-sm-3">
    <a href="/log?start_time={{ response.updated|date:'U' }}&key={{ response.key }}">
      {{ response.updated|timesince }} ago
      {% if response.status == 'error' %}
       <span title="Error" class="glyphicon glyphicon-exclamation-sign"></span>
      {% else %}{% if response.status == 'processing' %}
       <span title="Processing" class="glyphicon glyphicon-transfer"></span>
      {% endif %}{% endif %}
    </a>

   </div><div class="col-sm-3">
    {% if response.links %}
     {% if response.status == "complete" %} Sent {% else %} Sending {% endif %} to:
     <br />
     {{ response.links|safeseq|join:" <br /> " }}
    {% else %}{% if response.status == "complete" %}
     No post links found
    {% endif %}{% endif %}
   </div>
  </li>
  {% endfor %}
</ul>

{% endfor %}
</div>

{% endblock %}
